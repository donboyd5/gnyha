---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

```{r}
#| label: setup
e.print_min = tprint)

library(rlang)
library(here)
library(rprojroot)
library(this.path)
# library(lintr)
# library(styler)
library(btools)

library(tidyverse)
library(dplyr) # dplyr functions included with tidyverse, only if specifically loaded elsewhere
# remotes::install_github("JanMarvin/openxlsx2")
library(openxlsx2) # for writing xlsx files
library(readxl)
library(vroom)
library(fs)
library(skimr)
library(Hmisc)
library(lubridate)
library(formattable)
library(janitor)
library(vtable)
library(quarto)

# https://duckplyr.tidyverse.org/
library(dbplyr)
library(DBI)
library(duckplyr)

```

```{r}
#| label: locations

DACS5 <- r"(D:\data\acs\5year)"
DACS52023 <- fs::path(DACS5, "2023")
ACSDB <- "acs5year.duckdb"
path_duckdb <- fs::path(DACS5, ACSDB)

```


```{r}
acsdb <- DBI::dbConnect(duckdb::duckdb(path_duckdb))
DBI::dbListTables(acsdb)
# DBI::dbDisconnect(acsdb)
```

```{r}
#| label: examine

df <- tbl(acsdb, "pus_5year2023")
df

df |>
  explain()

count(df, fname)
colnames(df) |> sort()
glimpse(df)

df |>
  as_duckdb_tibble() |>
  explain()

nyacs <- df |>
  dplyr::filter(state == "36")
explain(nyacs)
soccodes <- count(nyacs, socp, sort = TRUE) |>
  as_duckdb_tibble() |>
  as_tibble()

nurses <- nyacs |>
  dplyr::filter(str_sub(socp, 1, 2) == "29") |>
  as_tibble()

tmp <- nurses |> dplyr::filter(socp == "291141") |> select(-c(pwgtp1:pwgtp80))
library(btools)
ns(tmp)
count(tmp, agep)

tmp |>
  count(agep) |>
  ggplot(aes(agep, n)) +
  geom_point() +
  scale_x_continuous(breaks = seq(0, 100, 5))

tmp |>
  dplyr::summarize(wtdn = sum(pwgtp), .by = agep) |>
  ggplot(aes(agep, wtdn)) +
  geom_point() +
  scale_x_continuous(breaks = seq(0, 100, 5)) +
  ggtitle("Weighted number of nurses in NY by age")

tmp |>
  dplyr::summarize(wtdn = sum(pwgtp), .by = agep) |>
  arrange(agep) |>
  mutate(pct = wtdn / sum(wtdn)) |>
  mutate(cumpct = cumsum(pct)) |>
  janitor::adorn_totals() |>
  kable()

```
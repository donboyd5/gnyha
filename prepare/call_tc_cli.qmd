---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

# Call tc-cli

```{r}
#| label: setup
tprint <- 50 # default tibble print
options(tibble.print_max = tprint, tibble.print_min = tprint)

library(rlang)
library(here)
library(rprojroot)
library(this.path)
# library(lintr)
# library(styler)
library(btools)

library(tidyverse)
library(dplyr) # dplyr functions included with tidyverse, only if specifically loaded elsewhere
# remotes::install_github("JanMarvin/openxlsx2")
library(openxlsx2) # for writing xlsx files
library(readxl)
library(vroom)
library(fs)
library(skimr)
library(Hmisc)
library(lubridate)
library(formattable)
library(janitor)
library(vtable)
library(quarto)

# https://duckplyr.tidyverse.org/
library(dbplyr)
library(DBI)
library(duckplyr)
library(RSQLite)

```


```{r}

# test.csv
# RECID,MARS,XTOT,EIC,e00200,e00200p,e00200s,p23250,e18400,e19800,s006
# 1,       2,   3,  1, 40000,  40000,      0,     0,  3000,  4000, 1e7
# 2,       2,   3,  1,200000, 200000,      0,     0, 15000, 20000, 1e7

cmd1 <- "C:/Users/Don-business/AppData/Local/Programs/Python/Python313/Scripts/tc.exe"
args <- c(
  shQuote(
    "--test"
  )
)
system2(cmd1, args)

cmd1 <- "tc.exe"
args <- c(
  shQuote("test.csv"),
  "2022",
  "--dumpdb",
  "--dumpvars",
  "ALL"
)
args <- c(
  shQuote("test.csv"),
  "2024",
  "--numyears", # creates a separate dump file for each year
  "4", # total number of years including the first year
  "--dumpdb",
  "--dumpvars",
  "ALL"
)
outdir <- "D:/R_projects/gnyha/data/tc_data/"
oldwd <- getwd()
setwd(outdir) # Go to target directory
system2(cmd1, args) # , stdout = "output.txt"
setwd(oldwd)

tcdb <- DBI::dbConnect(
  RSQLite::SQLite(),
  # "D:/R_projects/gnyha/data/tc_data/test-25-#-#-#.dumpdb"
  "D:/R_projects/gnyha/data/tc_data/test-27-#-#-#.dumpdb"
)
DBI::dbListTables(tcdb)
basedf <- dbReadTable(tcdb, "base")
bldf <- dbReadTable(tcdb, "baseline")
refdf <- dbReadTable(tcdb, "reform")
DBI::dbDisconnect(tcdb)


# test.csv input vars
# RECID,MARS,XTOT,EIC,e00200,e00200p,e00200s,p23250,e18400,e19800,s006

ns(basedf) # has RECID, MARS, XTOT, s006
ns(bldf) # has input vars other than MARS, XTOT, s006
ns(refdf) # same as bldf
glimpse(bldf)

# tc tmd.csv 2022 --numyears 14 --exact --tables --runid 21

```


```{r}
#| label: locations

DACS5 <- r"(D:\data\acs\5year)"
DACS52023 <- fs::path(DACS5, "2023")
ACSDB <- "acs5year.duckdb"
path_duckdb <- fs::path(DACS5, ACSDB)

```



---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

# Call tc-cli

```{r}
#| label: setup
tprint <- 50 # default tibble print
options(tibble.print_max = tprint, tibble.print_min = tprint)

library(rlang)
library(here)
library(rprojroot)
library(this.path)
# library(lintr)
# library(styler)
library(btools)

library(tidyverse)
library(dplyr) # dplyr functions included with tidyverse, only if specifically loaded elsewhere
# remotes::install_github("JanMarvin/openxlsx2")
library(openxlsx2) # for writing xlsx files
library(readxl)
library(vroom)
library(fs)
library(skimr)
library(Hmisc)
library(lubridate)
library(formattable)
library(janitor)
library(vtable)
library(quarto)

# https://duckplyr.tidyverse.org/
library(dbplyr)
library(DBI)
library(duckplyr)
library(RSQLite)

```

```{r}
#| label: create-test-data

# make some data
# df <- read_csv("data/tc_data/test.csv")
set.seed(1234)
nrecs <- 100
df <- tibble(RECID = 1:nrecs) |>
  mutate(
    MARS = sample(2:3, size = nrecs, replace = TRUE),
    e00200p = sample(seq(10e3, 100e3, 10e3), size = nrecs, replace = TRUE),
    e00200s = sample(
      c(0, 10e3, 20e3, 50e3),
      size = nrecs,
      replace = TRUE,
      prob = c(.7, .1, .1, .1)
    ),
    e00200s = e00200s * (MARS == 2), # married joint
    e00200 = e00200p + e00200s,
    XTOT = sample(2:3, size = nrecs, replace = TRUE),
    p23250 = sample(c(0, 20e3), size = nrecs, replace = TRUE, prob = c(.8, .2)),
    e18400 = sample(
      c(0, 5e3, 10e3, 20e3),
      size = nrecs,
      replace = TRUE,
      prob = c(.7, .1, .1, .1)
    ),
    e19800 = sample(
      c(0, 5e3, 10e3, 20e3),
      size = nrecs,
      replace = TRUE,
      prob = c(.7, .1, .1, .1)
    ),
    s006 = 1
  ) |>
  relocate(e00200, .after = MARS)

glimpse(df)
ht(df)
count(df, e00200)

write_csv(df, "data/tc_data/hholds.csv")

```


```{r}
#| label: run-tc-cli

run_tc <- function(fname) {
  cmd1 <- "tc.exe"
  args <- c(
    shQuote(fname),
    "2024",
    "--numyears", # creates a separate dump file for each year
    "4", # total number of years including the first year
    "--dumpdb",
    "--dumpvars",
    "ALL"
  )
  outdir <- "D:/R_projects/gnyha/data/tc_data/"
  oldwd <- getwd()
  setwd(outdir) # Go to target directory
  system2(cmd1, args) # , stdout = "output.txt"
  setwd(oldwd)
}

run_tc("hholds.csv")

```

```{r}
#| label: get-results

# hholds-24-#-#-#.dumpdb

get_tcout <- function(year) {
  y2 <- str_sub(as.character(year), 3, 4)
  fname <- paste0("hholds-", y2, "-#-#-#.dumpdb")
  print(fname)
  fpath <- paste0("D:/R_projects/gnyha/data/tc_data/", fname)
  tcdb <- DBI::dbConnect(
    RSQLite::SQLite(),
    fpath
  )
  basedf <- dbReadTable(tcdb, "base")
  baseline <- dbReadTable(tcdb, "baseline")
  DBI::dbDisconnect(tcdb)

  full <- basedf |>
    select(RECID, MARS, XTOT, s006) |>
    left_join(baseline, by = join_by(RECID)) |>
    mutate(year = {
      year
    }) |>
    relocate(year, .after = RECID)
  full
}

hhdf1 <- purrr::map(2024:2027, get_tcout) |>
  list_rbind()
glimpse(hhdf1)
count(hhdf1, year)
ns(hhdf1)

hhbase <- read_csv("data/tc_data/hholds.csv")
hhbase
hhbase |> filter(RECID == 12)
# e19800 is itemizable charitable giving

recn <- 87 # 74 is max agi; 28 is max iitax increase; 12 is max ddecrease
hhdf1 |>
  filter(RECID == recn) |>
  # calc saltsum because it is not shown if the person takes standard
  mutate(saltsum = e18400 + e18500) |> #  + e18800???
  select(
    RECID,
    year,
    FLPDYR,
    c00100,
    standard,
    idavail = c21060,
    idphased = c04470,
    saltsum,
    saltavail = c18300,
    ti = c04800,
    taxbc,
    nonref = c07100,
    refund,
    iitax
  )

hhdf1 |>
  filter(RECID == recn) |>
  ggplot(aes(year, iitax)) +
  geom_point()

hhdf1 |> filter(c00100 == max(c00100))

hhdf1 |>
  select(RECID, year, iitax) |>
  pivot_wider(names_from = year, values_from = iitax) |>
  mutate(diff = `2027` - `2024`) |>
  filter(diff == min(diff))

```
